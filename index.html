<!DOCTYPE html>
<html lang="ar">  
<head>  
  <meta charset="UTF-8" />  
  <title>📆 جدول أسبوعي — مواقيت القالة</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  

  <!-- PWA -->  
  <link rel="manifest" href="manifest.json">  
  <meta name="theme-color" content="#11998e">  
  <link rel="icon" href="icon.jpg" type="image/jpeg">  

  <style>  
    body {  
      font-family: "Cairo", Tahoma, sans-serif;  
      background: linear-gradient(135deg,#11998e,#38ef7d);  
      margin: 0;  
      padding: 20px;  
      text-align: center;  
      color: #fff;  
    }  
    h1 {  
      font-size: 2em;  
      margin-bottom: 20px;  
      padding: 10px 20px;  
      display: inline-block;  
      background: rgba(255,255,255,0.15);  
      border-radius: 12px;  
      border: 2px solid rgba(255,255,255,0.4);  
    }  
    table {  
      width: 60%;  
      margin: 20px auto;  
      border-collapse: collapse;  
      background: #fff;  
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);  
      color: #333;  
      border-radius: 15px;  
      overflow: hidden;  
      min-width: 280px;  
      max-width: 600px;  
    }  
    thead {background: #2ecc71; color: white; font-size: 1.2em;}  
    th,td {border:1px solid #ddd; padding:14px; font-size:1.1em; text-align:right;}  
    td input {  
      width: 95%;  
      padding: 10px;  
      border: 1px solid #ccc;  
      border-radius: 6px;  
      font-size: 1em;  
      text-align: right;  
      direction: rtl;  
      box-sizing: border-box;  
    }  
    tr:nth-child(even){background:#f9f9f9;}  
    tr:hover{background:#eafaf1;}  
    #dayTitle {  
      margin-bottom: 15px;  
      font-size: 1.5em;  
      font-weight: bold;  
      color: #fff;  
      text-shadow: 1px 1px 2px #00000055;  
    }  
    @media(max-width:480px){  
      table{width:90%;}  
      h1{font-size:1.5em;}  
    }  
  </style>  
</head>  
<body>  
  <h1>📆 جدول أسبوعي</h1>  
  <div id="dayTitle"></div>  
  <table>  
    <thead><tr><th>الفترة</th><th>المهمة</th></tr></thead>  
    <tbody id="scheduleBody"></tbody>  
  </table>  

  <script>  
    const days=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];  
    let currentDayIndex=new Date().getDay();  
    const scheduleBody=document.getElementById('scheduleBody');  
    const dayTitle=document.getElementById('dayTitle');  
    let timeCells=[],inputElems=[];  

    const baseTimes=[  
      "الفجر","07:00 - 12:00","12:00 - 13:30",  
      "13:30 - 16:30","16:30 - المغرب","المغرب - العشاء"  
    ];  

    function createTable(){  
      scheduleBody.innerHTML="";  
      timeCells=[]; inputElems=[];  
      for(let i=0;i<6;i++){  
        const tr=document.createElement('tr');  
        const tdTime=document.createElement('td');  
        tdTime.textContent=baseTimes[i];  
        const tdTask=document.createElement('td');  
        const input=document.createElement('input');  
        input.type="text";  
        const saved=localStorage.getItem(`${days[currentDayIndex]}_task_${i}`);  
        if(saved) input.value=saved;  
        input.addEventListener('input',()=>localStorage.setItem(`${days[currentDayIndex]}_task_${i}`,input.value));  
        tdTask.appendChild(input);  
        tr.appendChild(tdTime); tr.appendChild(tdTask);  
        scheduleBody.appendChild(tr);  
        timeCells.push(tdTime); inputElems.push(input);  
      }  
    }  

    function updateInputs(dayIdx){  
      dayTitle.textContent=`اليوم: ${days[dayIdx]}`;  
      inputElems.forEach((inp,i)=>{  
        const saved=localStorage.getItem(`${days[dayIdx]}_task_${i}`);  
        inp.value=saved||"";  
      });  
    }  

    async function fetchPrayerTimes(){  
      const url=`https://api.aladhan.com/v1/timingsByCity?city=El%20Kala&country=Algeria&method=3`;  
      try{  
        const res=await fetch(url);  
        const json=await res.json();  
        const t=json.data.timings;  

        let [mh,mm]=t.Maghrib.split(":").map(Number);  
        mm += 3;  
        if(mm >= 60){ mm -= 60; mh += 1; }  
        mh = (mh + 24) % 24;  
        const maghribAdj = `${String(mh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;  

        const times={  
          fajr: t.Fajr.slice(0,5),  
          maghrib: maghribAdj,  
          isha: t.Isha.slice(0,5)  
        };  

        localStorage.setItem("lastPrayerTimes", JSON.stringify(times));  
        localStorage.setItem("lastPrayerTimesFetchedAt", new Date().toISOString());  
        return times;  
      }catch(e){  
        const saved = localStorage.getItem("lastPrayerTimes");  
        if(saved) return JSON.parse(saved);  
        return {fajr:"05:00", maghrib:"18:33", isha:"19:30"};  
      }  
    }  

    async function updatePrayerCells(){  
      const times = await fetchPrayerTimes();  
      if(timeCells.length >= 6){  
        timeCells[0].textContent = `${times.fajr} - 07:00`;  
        timeCells[4].textContent = `16:30 - ${times.maghrib}`;  
        timeCells[5].textContent = `${times.maghrib} - ${times.isha}`;  
      }  
    }  

    let touchStartX = 0;  
    document.addEventListener("touchstart", e => { touchStartX = e.changedTouches[0].screenX; });  
    document.addEventListener("touchend", e => {  
      let touchEndX = e.changedTouches[0].screenX;  
      if(touchEndX - touchStartX > 50){ currentDayIndex = (currentDayIndex + 6) % 7; updateInputs(currentDayIndex); }  
      else if(touchStartX - touchEndX > 50){ currentDayIndex = (currentDayIndex + 1) % 7; updateInputs(currentDayIndex); }  
    });  

    createTable();  
    updateInputs(currentDayIndex);  
    updatePrayerCells();  

    // تسجيل Service Worker  
    if ("serviceWorker" in navigator) {  
      window.addEventListener("load", () => {  
        navigator.serviceWorker.register("./service-worker.js")  
          .then(reg => console.log("SW مسجل:", reg.scope))  
          .catch(err => console.error("خطأ SW:", err));  
      });  
    }  
  </script>  
</body>  
</html>